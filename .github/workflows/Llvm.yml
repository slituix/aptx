name: Build LLVM/Clang + libc++ for Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: 35
      ANDROID_ABIS: arm64-v8a  
      NDK_VERSION: r29
      LLVM_TAG: llvmorg-21.1.7

    steps:
      - name: Checkout LLVM source
        uses: actions/checkout@v6
        with:
          repository: llvm/llvm-project
          ref: ${{ env.LLVM_TAG }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}
        id: ndk

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake python3 build-essential

      - name: Configure & build per ABI
        run: |
          for ABI in ${{ env.ANDROID_ABIS }}; do
            BUILD_DIR=build-$ABI
            INSTALL_DIR=install-$ABI
            mkdir $BUILD_DIR
            cd $BUILD_DIR
            cmake ../llvm \
              -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DLLVM_ENABLE_PROJECTS="clang;lld;libcxx;libcxxabi" \
              -DLLVM_TARGETS_TO_BUILD="AArch64" \
              -DLLVM_ENABLE_LTO=Thin \
              -DLLVM_ENABLE_ASSERTIONS=OFF \
              -DCMAKE_TOOLCHAIN_FILE=${{ steps.ndk.outputs.ndk-path }}/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=$ABI \
              -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
              -DANDROID_STL=c++_static \
              -DCMAKE_INSTALL_PREFIX=$PWD/../${INSTALL_DIR} \
              -DCMAKE_C_FLAGS="-Ofast -fstrict-aliasing -fomit-frame-pointer -mcpu=cortex-a78" \
              -DCMAKE_CXX_FLAGS="-Ofast -fstrict-aliasing -fomit-frame-pointer -mcpu=cortex-a78" \
              -DLIBCXX_ENABLE_SHARED=OFF \
              -DLIBCXX_ENABLE_STATIC=ON
            ninja clang lld cxx
            ninja install
            cd ..
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: llvm-android-toolchain
          path: |
            install-arm64-v8a
